<html>
<head>
<title>test_io.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #a5c261;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_io.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Callable</span><span class="s2">, </span><span class="s1">Generator</span><span class="s2">, </span><span class="s1">List</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s2">..</span><span class="s1">_events </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ConnectionClosed</span><span class="s2">,</span>
    <span class="s1">Data</span><span class="s2">,</span>
    <span class="s1">EndOfMessage</span><span class="s2">,</span>
    <span class="s1">Event</span><span class="s2">,</span>
    <span class="s1">InformationalResponse</span><span class="s2">,</span>
    <span class="s1">Request</span><span class="s2">,</span>
    <span class="s1">Response</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_headers </span><span class="s0">import </span><span class="s1">Headers</span><span class="s2">, </span><span class="s1">normalize_and_validate</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_readers </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_obsolete_line_fold</span><span class="s2">,</span>
    <span class="s1">ChunkedReader</span><span class="s2">,</span>
    <span class="s1">ContentLengthReader</span><span class="s2">,</span>
    <span class="s1">Http10Reader</span><span class="s2">,</span>
    <span class="s1">READERS</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_receivebuffer </span><span class="s0">import </span><span class="s1">ReceiveBuffer</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_state </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">CLIENT</span><span class="s2">,</span>
    <span class="s1">CLOSED</span><span class="s2">,</span>
    <span class="s1">DONE</span><span class="s2">,</span>
    <span class="s1">IDLE</span><span class="s2">,</span>
    <span class="s1">MIGHT_SWITCH_PROTOCOL</span><span class="s2">,</span>
    <span class="s1">MUST_CLOSE</span><span class="s2">,</span>
    <span class="s1">SEND_BODY</span><span class="s2">,</span>
    <span class="s1">SEND_RESPONSE</span><span class="s2">,</span>
    <span class="s1">SERVER</span><span class="s2">,</span>
    <span class="s1">SWITCHED_PROTOCOL</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_util </span><span class="s0">import </span><span class="s1">LocalProtocolError</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">_writers </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ChunkedWriter</span><span class="s2">,</span>
    <span class="s1">ContentLengthWriter</span><span class="s2">,</span>
    <span class="s1">Http10Writer</span><span class="s2">,</span>
    <span class="s1">write_any_response</span><span class="s2">,</span>
    <span class="s1">write_headers</span><span class="s2">,</span>
    <span class="s1">write_request</span><span class="s2">,</span>
    <span class="s1">WRITERS</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">helpers </span><span class="s0">import </span><span class="s1">normalize_data_events</span>

<span class="s1">SIMPLE_CASES </span><span class="s2">= [</span>
    <span class="s2">(</span>
        <span class="s2">(</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">),</span>
        <span class="s1">Request</span><span class="s2">(</span>
            <span class="s1">method</span><span class="s2">=</span><span class="s3">&quot;GET&quot;</span><span class="s2">,</span>
            <span class="s1">target</span><span class="s2">=</span><span class="s3">&quot;/a&quot;</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Host&quot;</span><span class="s2">, </span><span class="s3">&quot;foo&quot;</span><span class="s2">), (</span><span class="s3">&quot;Connection&quot;</span><span class="s2">, </span><span class="s3">&quot;close&quot;</span><span class="s2">)],</span>
        <span class="s2">),</span>
        <span class="s4">b&quot;GET /a HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">Host: foo</span><span class="s0">\r\n</span><span class="s4">Connection: close</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s2">(</span>
        <span class="s2">(</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">),</span>
        <span class="s1">Response</span><span class="s2">(</span><span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Connection&quot;</span><span class="s2">, </span><span class="s3">&quot;close&quot;</span><span class="s2">)], </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;OK&quot;</span><span class="s2">),</span>
        <span class="s4">b&quot;HTTP/1.1 200 OK</span><span class="s0">\r\n</span><span class="s4">Connection: close</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s2">(</span>
        <span class="s2">(</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">),</span>
        <span class="s1">Response</span><span class="s2">(</span><span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[], </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;OK&quot;</span><span class="s2">),  </span><span class="s6"># type: ignore[arg-type]</span>
        <span class="s4">b&quot;HTTP/1.1 200 OK</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s2">(</span>
        <span class="s2">(</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">),</span>
        <span class="s1">InformationalResponse</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">101</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Upgrade&quot;</span><span class="s2">, </span><span class="s3">&quot;websocket&quot;</span><span class="s2">)], </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;Upgrade&quot;</span>
        <span class="s2">),</span>
        <span class="s4">b&quot;HTTP/1.1 101 Upgrade</span><span class="s0">\r\n</span><span class="s4">Upgrade: websocket</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
    <span class="s2">(</span>
        <span class="s2">(</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">),</span>
        <span class="s1">InformationalResponse</span><span class="s2">(</span><span class="s1">status_code</span><span class="s2">=</span><span class="s5">101</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[], </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;Upgrade&quot;</span><span class="s2">),  </span><span class="s6"># type: ignore[arg-type]</span>
        <span class="s4">b&quot;HTTP/1.1 101 Upgrade</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s2">),</span>
<span class="s2">]</span>


<span class="s0">def </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">: </span><span class="s1">Callable</span><span class="s2">[..., </span><span class="s0">None</span><span class="s2">], </span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
    <span class="s1">got_list</span><span class="s2">: </span><span class="s1">List</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">] = []</span>
    <span class="s1">writer</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">got_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s4">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">got_list</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">tw</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">got </span><span class="s2">= </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">writer</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">got </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">makebuf</span><span class="s2">(</span><span class="s1">data</span><span class="s2">: </span><span class="s1">bytes</span><span class="s2">) </span><span class="s1">-&gt; ReceiveBuffer</span><span class="s2">:</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">ReceiveBuffer</span><span class="s2">()</span>
    <span class="s1">buf </span><span class="s2">+= </span><span class="s1">data</span>
    <span class="s0">return </span><span class="s1">buf</span>


<span class="s0">def </span><span class="s1">tr</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">data</span><span class="s2">: </span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">got</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">got </span><span class="s2">== </span><span class="s1">expected</span>
        <span class="s6"># Headers should always be returned as bytes, not e.g. bytearray</span>
        <span class="s6"># https://github.com/python-hyper/wsproto/pull/54#issuecomment-377709478</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">got</span><span class="s2">, </span><span class="s3">&quot;headers&quot;</span><span class="s2">, []):</span>
            <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">name</span><span class="s2">) </span><span class="s0">is </span><span class="s1">bytes</span>
            <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">value</span><span class="s2">) </span><span class="s0">is </span><span class="s1">bytes</span>

    <span class="s6"># Simple: consume whole thing</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">makebuf</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">))</span>
    <span class="s0">assert not </span><span class="s1">buf</span>

    <span class="s6"># Incrementally growing buffer</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">ReceiveBuffer</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)):</span>
        <span class="s0">assert </span><span class="s1">reader</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">) </span><span class="s0">is None</span>
        <span class="s1">buf </span><span class="s2">+= </span><span class="s1">data</span><span class="s2">[</span><span class="s1">i </span><span class="s2">: </span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">))</span>

    <span class="s6"># Trailing data</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">makebuf</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">buf </span><span class="s2">+= </span><span class="s4">b&quot;trailing&quot;</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">bytes</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">) == </span><span class="s4">b&quot;trailing&quot;</span>


<span class="s0">def </span><span class="s1">test_writers_simple</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">for </span><span class="s2">((</span><span class="s1">role</span><span class="s2">, </span><span class="s1">state</span><span class="s2">), </span><span class="s1">event</span><span class="s2">, </span><span class="s1">binary</span><span class="s2">) </span><span class="s0">in </span><span class="s1">SIMPLE_CASES</span><span class="s2">:</span>
        <span class="s1">tw</span><span class="s2">(</span><span class="s1">WRITERS</span><span class="s2">[</span><span class="s1">role</span><span class="s2">, </span><span class="s1">state</span><span class="s2">], </span><span class="s1">event</span><span class="s2">, </span><span class="s1">binary</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_readers_simple</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">for </span><span class="s2">((</span><span class="s1">role</span><span class="s2">, </span><span class="s1">state</span><span class="s2">), </span><span class="s1">event</span><span class="s2">, </span><span class="s1">binary</span><span class="s2">) </span><span class="s0">in </span><span class="s1">SIMPLE_CASES</span><span class="s2">:</span>
        <span class="s1">tr</span><span class="s2">(</span><span class="s1">READERS</span><span class="s2">[</span><span class="s1">role</span><span class="s2">, </span><span class="s1">state</span><span class="s2">], </span><span class="s1">binary</span><span class="s2">, </span><span class="s1">event</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_writers_unusual</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s6"># Simple test of the write_headers utility routine</span>
    <span class="s1">tw</span><span class="s2">(</span>
        <span class="s1">write_headers</span><span class="s2">,</span>
        <span class="s1">normalize_and_validate</span><span class="s2">([(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s3">&quot;bar&quot;</span><span class="s2">), (</span><span class="s3">&quot;baz&quot;</span><span class="s2">, </span><span class="s3">&quot;quux&quot;</span><span class="s2">)]),</span>
        <span class="s4">b&quot;foo: bar</span><span class="s0">\r\n</span><span class="s4">baz: quux</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tw</span><span class="s2">(</span><span class="s1">write_headers</span><span class="s2">, </span><span class="s1">Headers</span><span class="s2">([]), </span><span class="s4">b&quot;</span><span class="s0">\r\n</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s6"># We understand HTTP/1.0, but we don't speak it</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tw</span><span class="s2">(</span>
            <span class="s1">write_request</span><span class="s2">,</span>
            <span class="s1">Request</span><span class="s2">(</span>
                <span class="s1">method</span><span class="s2">=</span><span class="s3">&quot;GET&quot;</span><span class="s2">,</span>
                <span class="s1">target</span><span class="s2">=</span><span class="s3">&quot;/&quot;</span><span class="s2">,</span>
                <span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Host&quot;</span><span class="s2">, </span><span class="s3">&quot;foo&quot;</span><span class="s2">), (</span><span class="s3">&quot;Connection&quot;</span><span class="s2">, </span><span class="s3">&quot;close&quot;</span><span class="s2">)],</span>
                <span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tw</span><span class="s2">(</span>
            <span class="s1">write_any_response</span><span class="s2">,</span>
            <span class="s1">Response</span><span class="s2">(</span>
                <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Connection&quot;</span><span class="s2">, </span><span class="s3">&quot;close&quot;</span><span class="s2">)], </span><span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span>
            <span class="s2">),</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_readers_unusual</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s6"># Reading HTTP/1.0</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
        <span class="s4">b&quot;HEAD /foo HTTP/1.0</span><span class="s0">\r\n</span><span class="s4">Some: header</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Request</span><span class="s2">(</span>
            <span class="s1">method</span><span class="s2">=</span><span class="s3">&quot;HEAD&quot;</span><span class="s2">,</span>
            <span class="s1">target</span><span class="s2">=</span><span class="s3">&quot;/foo&quot;</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Some&quot;</span><span class="s2">, </span><span class="s3">&quot;header&quot;</span><span class="s2">)],</span>
            <span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s6"># check no-headers, since it's only legal with HTTP/1.0</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
        <span class="s4">b&quot;HEAD /foo HTTP/1.0</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Request</span><span class="s2">(</span><span class="s1">method</span><span class="s2">=</span><span class="s3">&quot;HEAD&quot;</span><span class="s2">, </span><span class="s1">target</span><span class="s2">=</span><span class="s3">&quot;/foo&quot;</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[], </span><span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span><span class="s2">),  </span><span class="s6"># type: ignore[arg-type]</span>
    <span class="s2">)</span>

    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">],</span>
        <span class="s4">b&quot;HTTP/1.0 200 OK</span><span class="s0">\r\n</span><span class="s4">Some: header</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Response</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Some&quot;</span><span class="s2">, </span><span class="s3">&quot;header&quot;</span><span class="s2">)],</span>
            <span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span><span class="s2">,</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;OK&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s6"># single-character header values (actually disallowed by the ABNF in RFC</span>
    <span class="s6"># 7230 -- this is a bug in the standard that we originally copied...)</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">],</span>
        <span class="s4">b&quot;HTTP/1.0 200 OK</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;Foo: a a a a a </span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Response</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Foo&quot;</span><span class="s2">, </span><span class="s3">&quot;a a a a a&quot;</span><span class="s2">)],</span>
            <span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span><span class="s2">,</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;OK&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s6"># Empty headers -- also legal</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">],</span>
        <span class="s4">b&quot;HTTP/1.0 200 OK</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;Foo:</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Response</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Foo&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)], </span><span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;OK&quot;</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">],</span>
        <span class="s4">b&quot;HTTP/1.0 200 OK</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;Foo: </span><span class="s0">\t \t \r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Response</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Foo&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)], </span><span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;OK&quot;</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s6"># Tolerate broken servers that leave off the response code</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">],</span>
        <span class="s4">b&quot;HTTP/1.0 200</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;Foo: bar</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Response</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Foo&quot;</span><span class="s2">, </span><span class="s3">&quot;bar&quot;</span><span class="s2">)], </span><span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.0&quot;</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s4">b&quot;&quot;</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s6"># Tolerate headers line endings (\r\n and \n)</span>
    <span class="s6">#    \n\r\b between headers and body</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">],</span>
        <span class="s4">b&quot;HTTP/1.1 200 OK</span><span class="s0">\r\n</span><span class="s4">SomeHeader: val</span><span class="s0">\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Response</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;SomeHeader&quot;</span><span class="s2">, </span><span class="s3">&quot;val&quot;</span><span class="s2">)],</span>
            <span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.1&quot;</span><span class="s2">,</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;OK&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s6">#   delimited only with \n</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">],</span>
        <span class="s4">b&quot;HTTP/1.1 200 OK</span><span class="s0">\n</span><span class="s4">SomeHeader1: val1</span><span class="s0">\n</span><span class="s4">SomeHeader2: val2</span><span class="s0">\n\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Response</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;SomeHeader1&quot;</span><span class="s2">, </span><span class="s3">&quot;val1&quot;</span><span class="s2">), (</span><span class="s3">&quot;SomeHeader2&quot;</span><span class="s2">, </span><span class="s3">&quot;val2&quot;</span><span class="s2">)],</span>
            <span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.1&quot;</span><span class="s2">,</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;OK&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s6">#   mixed \r\n and \n</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">],</span>
        <span class="s4">b&quot;HTTP/1.1 200 OK</span><span class="s0">\r\n</span><span class="s4">SomeHeader1: val1</span><span class="s0">\n</span><span class="s4">SomeHeader2: val2</span><span class="s0">\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Response</span><span class="s2">(</span>
            <span class="s1">status_code</span><span class="s2">=</span><span class="s5">200</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;SomeHeader1&quot;</span><span class="s2">, </span><span class="s3">&quot;val1&quot;</span><span class="s2">), (</span><span class="s3">&quot;SomeHeader2&quot;</span><span class="s2">, </span><span class="s3">&quot;val2&quot;</span><span class="s2">)],</span>
            <span class="s1">http_version</span><span class="s2">=</span><span class="s3">&quot;1.1&quot;</span><span class="s2">,</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;OK&quot;</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s6"># obsolete line folding</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
        <span class="s4">b&quot;HEAD /foo HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;Host: example.com</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;Some: multi-line</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot; header</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;</span><span class="s0">\t</span><span class="s4">nonsense</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;    </span><span class="s0">\t   \t\t</span><span class="s4">I guess</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;Connection: close</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;More-nonsense: in the</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;    last header  </span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Request</span><span class="s2">(</span>
            <span class="s1">method</span><span class="s2">=</span><span class="s3">&quot;HEAD&quot;</span><span class="s2">,</span>
            <span class="s1">target</span><span class="s2">=</span><span class="s3">&quot;/foo&quot;</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[</span>
                <span class="s2">(</span><span class="s3">&quot;Host&quot;</span><span class="s2">, </span><span class="s3">&quot;example.com&quot;</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s3">&quot;Some&quot;</span><span class="s2">, </span><span class="s3">&quot;multi-line header nonsense I guess&quot;</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s3">&quot;Connection&quot;</span><span class="s2">, </span><span class="s3">&quot;close&quot;</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s3">&quot;More-nonsense&quot;</span><span class="s2">, </span><span class="s3">&quot;in the last header&quot;</span><span class="s2">),</span>
            <span class="s2">],</span>
        <span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tr</span><span class="s2">(</span>
            <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
            <span class="s4">b&quot;HEAD /foo HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;  folded: line</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tr</span><span class="s2">(</span>
            <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
            <span class="s4">b&quot;HEAD /foo HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;foo  : line</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tr</span><span class="s2">(</span>
            <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
            <span class="s4">b&quot;HEAD /foo HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;foo</span><span class="s0">\t</span><span class="s4">: line</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tr</span><span class="s2">(</span>
            <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
            <span class="s4">b&quot;HEAD /foo HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;foo</span><span class="s0">\t</span><span class="s4">: line</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tr</span><span class="s2">(</span><span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">], </span><span class="s4">b&quot;HEAD /foo HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;: line</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test__obsolete_line_fold_bytes</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s6"># _obsolete_line_fold has a defensive cast to bytearray, which is</span>
    <span class="s6"># necessary to protect against O(n^2) behavior in case anyone ever passes</span>
    <span class="s6"># in regular bytestrings... but right now we never pass in regular</span>
    <span class="s6"># bytestrings. so this test just exists to get some coverage on that</span>
    <span class="s6"># defensive cast.</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">_obsolete_line_fold</span><span class="s2">([</span><span class="s4">b&quot;aaa&quot;</span><span class="s2">, </span><span class="s4">b&quot;bbb&quot;</span><span class="s2">, </span><span class="s4">b&quot;  ccc&quot;</span><span class="s2">, </span><span class="s4">b&quot;ddd&quot;</span><span class="s2">])) == [</span>
        <span class="s4">b&quot;aaa&quot;</span><span class="s2">,</span>
        <span class="s1">bytearray</span><span class="s2">(</span><span class="s4">b&quot;bbb ccc&quot;</span><span class="s2">),</span>
        <span class="s4">b&quot;ddd&quot;</span><span class="s2">,</span>
    <span class="s2">]</span>


<span class="s0">def </span><span class="s1">_run_reader_iter</span><span class="s2">(</span>
    <span class="s1">reader</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">buf</span><span class="s2">: </span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">do_eof</span><span class="s2">: </span><span class="s1">bool</span>
<span class="s2">) </span><span class="s1">-&gt; Generator</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
    <span class="s0">while True</span><span class="s2">:</span>
        <span class="s1">event </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">event </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">break</span>
        <span class="s0">yield </span><span class="s1">event</span>
        <span class="s6"># body readers have undefined behavior after returning EndOfMessage,</span>
        <span class="s6"># because this changes the state so they don't get called again</span>
        <span class="s0">if </span><span class="s1">type</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) </span><span class="s0">is </span><span class="s1">EndOfMessage</span><span class="s2">:</span>
            <span class="s0">break</span>
    <span class="s0">if </span><span class="s1">do_eof</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">buf</span>
        <span class="s0">yield </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">read_eof</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">_run_reader</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; List</span><span class="s2">[</span><span class="s1">Event</span><span class="s2">]:</span>
    <span class="s1">events </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">_run_reader_iter</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">normalize_data_events</span><span class="s2">(</span><span class="s1">events</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">t_body_reader</span><span class="s2">(</span><span class="s1">thunk</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">data</span><span class="s2">: </span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">: </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">do_eof</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">False</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s6"># Simple: consume whole thing</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Test 1&quot;</span><span class="s2">)</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">makebuf</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">_run_reader</span><span class="s2">(</span><span class="s1">thunk</span><span class="s2">(), </span><span class="s1">buf</span><span class="s2">, </span><span class="s1">do_eof</span><span class="s2">) == </span><span class="s1">expected</span>

    <span class="s6"># Incrementally growing buffer</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Test 2&quot;</span><span class="s2">)</span>
    <span class="s1">reader </span><span class="s2">= </span><span class="s1">thunk</span><span class="s2">()</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">ReceiveBuffer</span><span class="s2">()</span>
    <span class="s1">events </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)):</span>
        <span class="s1">events </span><span class="s2">+= </span><span class="s1">_run_reader</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">buf</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">+= </span><span class="s1">data</span><span class="s2">[</span><span class="s1">i </span><span class="s2">: </span><span class="s1">i </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">events </span><span class="s2">+= </span><span class="s1">_run_reader</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">, </span><span class="s1">buf</span><span class="s2">, </span><span class="s1">do_eof</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">normalize_data_events</span><span class="s2">(</span><span class="s1">events</span><span class="s2">) == </span><span class="s1">expected</span>

    <span class="s1">is_complete </span><span class="s2">= </span><span class="s1">any</span><span class="s2">(</span><span class="s1">type</span><span class="s2">(</span><span class="s1">event</span><span class="s2">) </span><span class="s0">is </span><span class="s1">EndOfMessage </span><span class="s0">for </span><span class="s1">event </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">is_complete </span><span class="s0">and not </span><span class="s1">do_eof</span><span class="s2">:</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">makebuf</span><span class="s2">(</span><span class="s1">data </span><span class="s2">+ </span><span class="s4">b&quot;trailing&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">_run_reader</span><span class="s2">(</span><span class="s1">thunk</span><span class="s2">(), </span><span class="s1">buf</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) == </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_ContentLengthReader</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">t_body_reader</span><span class="s2">(</span><span class="s0">lambda</span><span class="s2">: </span><span class="s1">ContentLengthReader</span><span class="s2">(</span><span class="s5">0</span><span class="s2">), </span><span class="s4">b&quot;&quot;</span><span class="s2">, [</span><span class="s1">EndOfMessage</span><span class="s2">()])</span>

    <span class="s1">t_body_reader</span><span class="s2">(</span>
        <span class="s0">lambda</span><span class="s2">: </span><span class="s1">ContentLengthReader</span><span class="s2">(</span><span class="s5">10</span><span class="s2">),</span>
        <span class="s4">b&quot;0123456789&quot;</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;0123456789&quot;</span><span class="s2">), </span><span class="s1">EndOfMessage</span><span class="s2">()],</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_Http10Reader</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">t_body_reader</span><span class="s2">(</span><span class="s1">Http10Reader</span><span class="s2">, </span><span class="s4">b&quot;&quot;</span><span class="s2">, [</span><span class="s1">EndOfMessage</span><span class="s2">()], </span><span class="s1">do_eof</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">t_body_reader</span><span class="s2">(</span><span class="s1">Http10Reader</span><span class="s2">, </span><span class="s4">b&quot;asdf&quot;</span><span class="s2">, [</span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;asdf&quot;</span><span class="s2">)], </span><span class="s1">do_eof</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">t_body_reader</span><span class="s2">(</span>
        <span class="s1">Http10Reader</span><span class="s2">, </span><span class="s4">b&quot;asdf&quot;</span><span class="s2">, [</span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;asdf&quot;</span><span class="s2">), </span><span class="s1">EndOfMessage</span><span class="s2">()], </span><span class="s1">do_eof</span><span class="s2">=</span><span class="s0">True</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ChunkedReader</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">t_body_reader</span><span class="s2">(</span><span class="s1">ChunkedReader</span><span class="s2">, </span><span class="s4">b&quot;0</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">, [</span><span class="s1">EndOfMessage</span><span class="s2">()])</span>

    <span class="s1">t_body_reader</span><span class="s2">(</span>
        <span class="s1">ChunkedReader</span><span class="s2">,</span>
        <span class="s4">b&quot;0</span><span class="s0">\r\n</span><span class="s4">Some: header</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">EndOfMessage</span><span class="s2">(</span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Some&quot;</span><span class="s2">, </span><span class="s3">&quot;header&quot;</span><span class="s2">)])],</span>
    <span class="s2">)</span>

    <span class="s1">t_body_reader</span><span class="s2">(</span>
        <span class="s1">ChunkedReader</span><span class="s2">,</span>
        <span class="s4">b&quot;5</span><span class="s0">\r\n</span><span class="s4">01234</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s2">+ </span><span class="s4">b&quot;10</span><span class="s0">\r\n</span><span class="s4">0123456789abcdef</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s2">+ </span><span class="s4">b&quot;0</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s2">+ </span><span class="s4">b&quot;Some: header</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;012340123456789abcdef&quot;</span><span class="s2">),</span>
            <span class="s1">EndOfMessage</span><span class="s2">(</span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Some&quot;</span><span class="s2">, </span><span class="s3">&quot;header&quot;</span><span class="s2">)]),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">t_body_reader</span><span class="s2">(</span>
        <span class="s1">ChunkedReader</span><span class="s2">,</span>
        <span class="s4">b&quot;5</span><span class="s0">\r\n</span><span class="s4">01234</span><span class="s0">\r\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s4">b&quot;10</span><span class="s0">\r\n</span><span class="s4">0123456789abcdef</span><span class="s0">\r\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s4">b&quot;0</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;012340123456789abcdef&quot;</span><span class="s2">), </span><span class="s1">EndOfMessage</span><span class="s2">()],</span>
    <span class="s2">)</span>

    <span class="s6"># handles upper and lowercase hex</span>
    <span class="s1">t_body_reader</span><span class="s2">(</span>
        <span class="s1">ChunkedReader</span><span class="s2">,</span>
        <span class="s4">b&quot;aA</span><span class="s0">\r\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s4">b&quot;x&quot; </span><span class="s2">* </span><span class="s5">0xAA </span><span class="s2">+ </span><span class="s4">b&quot;</span><span class="s0">\r\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s4">b&quot;0</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;x&quot; </span><span class="s2">* </span><span class="s5">0xAA</span><span class="s2">), </span><span class="s1">EndOfMessage</span><span class="s2">()],</span>
    <span class="s2">)</span>

    <span class="s6"># refuses arbitrarily long chunk integers</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s6"># Technically this is legal HTTP/1.1, but we refuse to process chunk</span>
        <span class="s6"># sizes that don't fit into 20 characters of hex</span>
        <span class="s1">t_body_reader</span><span class="s2">(</span><span class="s1">ChunkedReader</span><span class="s2">, </span><span class="s4">b&quot;9&quot; </span><span class="s2">* </span><span class="s5">100 </span><span class="s2">+ </span><span class="s4">b&quot;</span><span class="s0">\r\n</span><span class="s4">xxx&quot;</span><span class="s2">, [</span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;xxx&quot;</span><span class="s2">)])</span>

    <span class="s6"># refuses garbage in the chunk count</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">t_body_reader</span><span class="s2">(</span><span class="s1">ChunkedReader</span><span class="s2">, </span><span class="s4">b&quot;10</span><span class="s0">\x00\r\n</span><span class="s4">xxx&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s6"># handles (and discards) &quot;chunk extensions&quot; omg wtf</span>
    <span class="s1">t_body_reader</span><span class="s2">(</span>
        <span class="s1">ChunkedReader</span><span class="s2">,</span>
        <span class="s4">b&quot;5; hello=there</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s2">+ </span><span class="s4">b&quot;xxxxx&quot;</span>
        <span class="s2">+ </span><span class="s4">b&quot;</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s2">+ </span><span class="s4">b'0; random=&quot;junk&quot;; some=more; canbe=lonnnnngg</span><span class="s0">\r\n\r\n</span><span class="s4">'</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;xxxxx&quot;</span><span class="s2">), </span><span class="s1">EndOfMessage</span><span class="s2">()],</span>
    <span class="s2">)</span>

    <span class="s1">t_body_reader</span><span class="s2">(</span>
        <span class="s1">ChunkedReader</span><span class="s2">,</span>
        <span class="s4">b&quot;5      </span><span class="s0">\r\n</span><span class="s4">01234</span><span class="s0">\r\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s4">b&quot;0</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;01234&quot;</span><span class="s2">), </span><span class="s1">EndOfMessage</span><span class="s2">()],</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ContentLengthWriter</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">w </span><span class="s2">= </span><span class="s1">ContentLengthWriter</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;123&quot;</span><span class="s2">)) == </span><span class="s4">b&quot;123&quot;</span>
    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;45&quot;</span><span class="s2">)) == </span><span class="s4">b&quot;45&quot;</span>
    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">EndOfMessage</span><span class="s2">()) == </span><span class="s4">b&quot;&quot;</span>

    <span class="s1">w </span><span class="s2">= </span><span class="s1">ContentLengthWriter</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;123456&quot;</span><span class="s2">))</span>

    <span class="s1">w </span><span class="s2">= </span><span class="s1">ContentLengthWriter</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;123&quot;</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;456&quot;</span><span class="s2">))</span>

    <span class="s1">w </span><span class="s2">= </span><span class="s1">ContentLengthWriter</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;123&quot;</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">EndOfMessage</span><span class="s2">())</span>

    <span class="s1">w </span><span class="s2">= </span><span class="s1">ContentLengthWriter</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;123&quot;</span><span class="s2">)) == </span><span class="s4">b&quot;123&quot;</span>
    <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;45&quot;</span><span class="s2">)) == </span><span class="s4">b&quot;45&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">EndOfMessage</span><span class="s2">(</span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Etag&quot;</span><span class="s2">, </span><span class="s3">&quot;asdf&quot;</span><span class="s2">)]))</span>


<span class="s0">def </span><span class="s1">test_ChunkedWriter</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">w </span><span class="s2">= </span><span class="s1">ChunkedWriter</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;aaa&quot;</span><span class="s2">)) == </span><span class="s4">b&quot;3</span><span class="s0">\r\n</span><span class="s4">aaa</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;a&quot; </span><span class="s2">* </span><span class="s5">20</span><span class="s2">)) == </span><span class="s4">b&quot;14</span><span class="s0">\r\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s4">b&quot;a&quot; </span><span class="s2">* </span><span class="s5">20 </span><span class="s2">+ </span><span class="s4">b&quot;</span><span class="s0">\r\n</span><span class="s4">&quot;</span>

    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;&quot;</span><span class="s2">)) == </span><span class="s4">b&quot;&quot;</span>

    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">EndOfMessage</span><span class="s2">()) == </span><span class="s4">b&quot;0</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span>

    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">EndOfMessage</span><span class="s2">(</span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Etag&quot;</span><span class="s2">, </span><span class="s3">&quot;asdf&quot;</span><span class="s2">), (</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">)]))</span>
        <span class="s2">== </span><span class="s4">b&quot;0</span><span class="s0">\r\n</span><span class="s4">Etag: asdf</span><span class="s0">\r\n</span><span class="s4">a: b</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_Http10Writer</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">w </span><span class="s2">= </span><span class="s1">Http10Writer</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">Data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s4">b&quot;1234&quot;</span><span class="s2">)) == </span><span class="s4">b&quot;1234&quot;</span>
    <span class="s0">assert </span><span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">EndOfMessage</span><span class="s2">()) == </span><span class="s4">b&quot;&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">dowrite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">EndOfMessage</span><span class="s2">(</span><span class="s1">headers</span><span class="s2">=[(</span><span class="s3">&quot;Etag&quot;</span><span class="s2">, </span><span class="s3">&quot;asdf&quot;</span><span class="s2">)]))</span>


<span class="s0">def </span><span class="s1">test_reject_garbage_after_request_line</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tr</span><span class="s2">(</span><span class="s1">READERS</span><span class="s2">[</span><span class="s1">SERVER</span><span class="s2">, </span><span class="s1">SEND_RESPONSE</span><span class="s2">], </span><span class="s4">b&quot;HTTP/1.0 200 OK</span><span class="s0">\x00</span><span class="s4">xxxx</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_reject_garbage_after_response_line</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tr</span><span class="s2">(</span>
            <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
            <span class="s4">b&quot;HEAD /foo HTTP/1.1 xxxxxx</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;Host: a</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_reject_garbage_in_header_line</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
        <span class="s1">tr</span><span class="s2">(</span>
            <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
            <span class="s4">b&quot;HEAD /foo HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">&quot; b&quot;Host: foo</span><span class="s0">\x00</span><span class="s4">bar</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
            <span class="s0">None</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_reject_non_vchar_in_path</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s0">for </span><span class="s1">bad_char </span><span class="s0">in </span><span class="s4">b&quot;</span><span class="s0">\x00\x20\x7f\xee</span><span class="s4">&quot;</span><span class="s2">:</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s1">bytearray</span><span class="s2">(</span><span class="s4">b&quot;HEAD /&quot;</span><span class="s2">)</span>
        <span class="s1">message</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">bad_char</span><span class="s2">)</span>
        <span class="s1">message</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s4">b&quot; HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">Host: foobar</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LocalProtocolError</span><span class="s2">):</span>
            <span class="s1">tr</span><span class="s2">(</span><span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">], </span><span class="s1">message</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>


<span class="s6"># https://github.com/python-hyper/h11/issues/57</span>
<span class="s0">def </span><span class="s1">test_allow_some_garbage_in_cookies</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">tr</span><span class="s2">(</span>
        <span class="s1">READERS</span><span class="s2">[</span><span class="s1">CLIENT</span><span class="s2">, </span><span class="s1">IDLE</span><span class="s2">],</span>
        <span class="s4">b&quot;HEAD /foo HTTP/1.1</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;Host: foo</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;Set-Cookie: ___utmvafIumyLc=kUd</span><span class="s0">\x01</span><span class="s4">UpAt; path=/; Max-Age=900</span><span class="s0">\r\n</span><span class="s4">&quot;</span>
        <span class="s4">b&quot;</span><span class="s0">\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
        <span class="s1">Request</span><span class="s2">(</span>
            <span class="s1">method</span><span class="s2">=</span><span class="s3">&quot;HEAD&quot;</span><span class="s2">,</span>
            <span class="s1">target</span><span class="s2">=</span><span class="s3">&quot;/foo&quot;</span><span class="s2">,</span>
            <span class="s1">headers</span><span class="s2">=[</span>
                <span class="s2">(</span><span class="s3">&quot;Host&quot;</span><span class="s2">, </span><span class="s3">&quot;foo&quot;</span><span class="s2">),</span>
                <span class="s2">(</span><span class="s3">&quot;Set-Cookie&quot;</span><span class="s2">, </span><span class="s3">&quot;___utmvafIumyLc=kUd</span><span class="s0">\x01</span><span class="s3">UpAt; path=/; Max-Age=900&quot;</span><span class="s2">),</span>
            <span class="s2">],</span>
        <span class="s2">),</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_host_comes_first</span><span class="s2">() </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
    <span class="s1">tw</span><span class="s2">(</span>
        <span class="s1">write_headers</span><span class="s2">,</span>
        <span class="s1">normalize_and_validate</span><span class="s2">([(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s3">&quot;bar&quot;</span><span class="s2">), (</span><span class="s3">&quot;Host&quot;</span><span class="s2">, </span><span class="s3">&quot;example.com&quot;</span><span class="s2">)]),</span>
        <span class="s4">b&quot;Host: example.com</span><span class="s0">\r\n</span><span class="s4">foo: bar</span><span class="s0">\r\n\r\n</span><span class="s4">&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
</pre>
</body>
</html>